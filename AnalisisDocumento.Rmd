---
title: "Analisis Exploratorio"
author: "Miguel Angel G.G"
date: "28/1/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(plyr)
library(dplyr)
library(reshape2)
library(ggplot2)
library(psych)
```

## Introducción


### Revisión preeliminar de archivo


```{r pressure, echo=FALSE}

data <- read.csv("Credit_Card.csv")
str(data)
```
En este conjunto de datos, se tienen 30,000 registros, con 25 variables cada una. Algunos pertenecientes a datos demográficos, y otros a datos de su respectiva cuenta bancaria.

Los datos categoricos (sexo, educación y estado marital) están codificados como enteros. Se procede a dejar las categorías explícitas:
```{r}
data$SEX <- factor(ifelse(data$SEX==1,"Hombre","Mujer"))

data$EDUCATION <- factor(mapvalues(data$EDUCATION,0:6,c("Desc","MaestriaD","Licenciatura","Prepa","Otra","Desc","Desc")))

data$MARRIAGE <- factor(mapvalues(data$MARRIAGE, 0:3, c("Otro","Casada","Soltera","Otro")))

colnames(data)[25] <- "default"
colnames(data)[7] <- "PAY_1"
```

Las columnas restantes son en realidad 3 variables distintas, con 6 observaciones cada una. Se emplea la operación melt para cumplir los criterios del "dataset ordenado".

```{r}
paycol <- melt(data,id.vars=colnames(data)[-(7:12)],measured.vars=7:12, variable.name = "MONTHSBEFORE",value.name = "PENDINGPAYS")

paycol$MONTHSBEFORE <- sub(".*([[:digit:]])",x=paycol$MONTHSBEFORE, replacement="\\1" )

billcol <- melt(data,id.vars=colnames(data)[-(13:18)],measured.vars=13:18, variable.name = "MONTHSBEFORE",value.name = "BILL")

billcol$MONTHSBEFORE <- sub(".*([[:digit:]])",x=billcol$MONTHSBEFORE, replacement="\\1" )

amcol <- melt(data,id.vars=colnames(data)[-(19:24)],measured.vars=19:24, variable.name = "MONTHSBEFORE",value.name = "AMORTIZATION")

amcol$MONTHSBEFORE <- sub(".*([[:digit:]])",x=amcol$MONTHSBEFORE, replacement="\\1" )

tdata <- select(data,c((1:6),25))
paycol <- select(paycol,c(1,20,21))
amcol <- select(amcol,c(1,20,21))
billcol <- select(billcol,c(1,20,21))

columns <- join_all(lst(paycol,amcol,billcol),by=c("ID","MONTHSBEFORE"))
tdata <- join(tdata,columns,by="ID") %>%
  arrange(ID,MONTHSBEFORE) %>%
  select(1,8,2,3,4,5,6,9,10,11,7)

tdata$default <- factor(as.numeric(tdata$default))
tdata$MONTHSBEFORE <- as.numeric(tdata$MONTHSBEFORE)
```

## Analisis Exploratorio

### Prevalencia de default

```{r}
prevalence <- mean(data$default==1)
```

La prevalencia del incumplimiento de pago en el mes actual es del `r prevalence*100`%

### Correlación entre variables continuas-outcome

Se obtiene una matriz de correlación para todas las variables numericas continuas:
```{r}
cor.plot(select(data,c(-1,-(3:5))))
```

Se observa que las variables con mayor correlación con la variable de interés son los registros de los pagos atrasados mes con mes (PAY_X), y el límite de crédito (LIMIT_BAL), en ese orden. Sin embargo, los registros del estado de cuenta y cantidad pagada mensualmente parecen no tener relación directa.

### Correlación entre variables discretas - outcome

### Género

```{r}
data$default <- factor(data$default)

ggplot(aes(x=SEX,fill=default),data=data)+geom_bar(position=position_fill())+labs(title="Probabilidad de default",subtitle="Por género")+xlab("Género")+ylab("Probabilidad")+geom_hline(yintercept = prevalence)
```

Se observa una muy sutil diferencia en los porcentajes de probabilidad de default. La linea horizontal marca la prevalencia. Para corroborar esta correlación, aunque sutil, se realiza un test chi-square.

```{r}
chisq.test(data$SEX,data$default)
```
Se verifica entonces la correlación entre género e incidencia de default.

### Grado de Educación

```{r}
ggplot(aes(x=EDUCATION,fill=default),data=data)+geom_bar(position=position_fill())+labs(title="Probabilidad de Default",subtitle="Por grado de educación")+xlab("Grado")+ylab("Probabilidad")+geom_hline(yintercept = prevalence)
```
En cuanto al grado educativo, se observan ligeras diferencias entre las categorias, resaltando las categorías "Desconocido" y "Otra", donde la probilidad de default es marcadamente menor. 

Sin embargo, se podría pensar que esta diferencia se debe a la escaza cantidad de registros en dichas categorías y que, por lo tanto, en realidad esa diferencia es debida a solo unas cuantas personas que ejercen mucha influencia en el porcentaje. Si construimos la tabla de contingencia para esta relación y realizamos un test chi-square...

```{r}
chisq.test(with(data,table(EDUCATION, default)))
```
El p-value para este test es muy bajo y por lo tanto verifica la relación.

### Estado Marital

```{r}
ggplot(aes(x=MARRIAGE,fill=default),data=data)+geom_bar(position=position_fill())+labs(title="Probabilidad de Default",subtitle="Por estado marital")+xlab("Estado")+ylab("Probabilidad")+geom_hline(yintercept = prevalence)
```
La diferencia entre los grupos "Casado-Otro" es prácticamente nula, sin embargo, el grupo de Solteros tiene un menor indice de impago.

### Historial de Retraso de Pagos
Como se puede ver en la matriz de correlación, los valores que tienen mayor correlación con respecto a la variable de interés (default) son los registros de la variable PAY_n, que representa el número de pagos vencidos acumulados cada mes. 

Sin embargo, y es de esperarse, los 6 observaciones de la variable PAY_n estan estrechamente relacionadas. Por lo que, incluir todas esas observaciones en un futuro modelo, puede incrementar la varianza de los coeficientes en una regresión. 

Se grafica la distribución de los valores de PAY_1 (el registro más actual y por ende, el más significativo para la probabilidad impago").


```{r}
ggplot(aes(x=PAY_1,fill=default),data=data)+geom_bar(alpha=0.4, position= position_stack())+labs(title="Probabilidad de impago",subtitle = "En función del número de pagos vencidos el mes anterior")+xlab("Default")+ylab("Probabilidad de default")+coord_cartesian(xlim=c(-4,10))+geom_hline(yintercept = prevalence)+geom_vline(xintercept = 0)+coord_cartesian(xlim=c(-5,5))
```
Se aprecia un notable incremento en la probabilidad de impago cuando el número de pagos vencidos acumulados el mes anterior es mayor a 1. 

Se realiza un t-test para tener certeza en la existencia de esta diferencia en las distribuciones:
```{r}
t.test(data$PAY_1,as.numeric(data$default),paired=FALSE)
```


### Límite de Crédito

```{r warning=FALSE}
ggplot(aes(x=LIMIT_BAL, fill=default),data=tdata)+geom_density(alpha=0.3)+labs(title="Límite de Crédito")+ylab("Proporción")+xlab("Límite de Crédito [$]")
```
Se puede observar que, conforme el límite de crédito aumenta, disminuye la proporción de usuarios que incumplen el pago. Aunque

### Edad

```{r}
ggplot(aes(x=AGE,fill=default),data=data)+geom_bar(position=position_fill())+labs(title="Edad")+xlab("Años")+ylab("Probabilidad de Impago")+geom_hline(yintercept = prevalence)
```

En el intevalo de 20 a 50 años se notan valores ligeramente menores que en el intervalo de 50 en adelante. Este ligera diferencia se puede deber a la relación de la edad con otras variables demográficas:

```{r}
ggplot(aes(x=AGE,fill=EDUCATION),data=data)+geom_bar(position = position_stack())+labs(title="Grado Educativo por edad")+xlab("Edad")+ylab("Cantidad")
```
En el intervalo de personas de alrededor de 30 años, predomina la maestría, del cual se observó, es un grupo con menor indice de falta de pago.


```{r}
ggplot(aes(x=AGE,fill=MARRIAGE),data=data)+geom_bar(position =  position_stack())+labs(title="Estado Marital por Edad")+xlab("Edad")+ylab("Cantidad")
```
Además, en dicho grupo la mayoría son solteros, grupo que también se identificó con un menor índice de falta de pago.

### Historial de Amortizaciones

A pesar que la matriz de correlación indique que los valores individuales del historial de amortizaciones no estan relacionados directamente con la incidencia de default, se puede deducir que el número de registros con pagos de $0 puede indicar una tendencia a faltar el siguiente pago.

```{r}
userg <- tdata %>% group_by(ID,default) %>% summarize(NNULLPAYMENTS = sum(AMORTIZATION==0))


ggplot(aes(x=NNULLPAYMENTS,fill=default),data=userg)+geom_bar(position=position_fill())+xlab("Numero de pagos nulos")+ylab("Probabilidad")+geom_hline(yintercept = prevalence)
```
Se observa un incremento en la probabilidad de default conforme el número de pagos nulos es más alto. 

```{r}
seldata = select(userg,ID,NNULLPAYMENTS) %>% join(data,by="ID") %>% select(NNULLPAYMENTS,LIMIT_BAL,SEX,EDUCATION,MARRIAGE,AGE,PAY_1,default)

```
### Número de meses con pagos atrasados

Hasta ahora se revisó la correlación entre la incidencia de impago y el registro más actual de la variable PAY_X. Sin embargo, se puede sacar provecho de los registros anteriores, si se cuenta el número de meses con pagos atrasados, esto sugerirá que el usuario es un cierta medida irregular, y que por ende puede haber mayor probabilidad de que incumpla.

```{r}
seg <- tdata %>% group_by(ID,default) %>% summarise(IRREGMONTHS=sum(PENDINGPAYS>0))

seldata <- join(seldata,select(seg,ID,IRREGMONTHS),by="ID")

ggplot(aes(x=IRREGMONTHS, fill=default),data=seg)+geom_bar(position=position_fill())+labs(title="Meses irregulares",subtitle = "vs Probabilidad de Impago")+ylab("Proporción")+xlab("Meses Irregulares")
```

Se observa una proporcionalidad lineal entre el número de meses con irregularidades y la probabilidad de impago.
