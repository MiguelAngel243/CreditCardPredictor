---
title: "Analisis Exploratorio"
author: "Miguel Angel G.G"
date: "28/1/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(plyr)
library(dplyr)
library(reshape2)
library(ggplot2)
```

## Introducción


### Revisión preeliminar de archivo


```{r pressure, echo=FALSE}

data <- read.csv("Credit_Card.csv")
str(data)
```
Los datos categoricos (sexo, educación y estado marital) están codificados como enteros. Se procede a dejar las categorías explícitas:
```{r}
data$SEX <- factor(ifelse(data$SEX==1,"Hombre","Mujer"))

data$EDUCATION <- factor(mapvalues(data$EDUCATION,0:6,c("Desc","MaestriaD","Licenciatura","Prepa","Otra","Desc","Desc")))

data$MARRIAGE <- factor(mapvalues(data$MARRIAGE, 0:3, c("Otro","Casada","Soltera","Otro")))

colnames(data)[25] <- "default"
colnames(data)[7] <- "PAY_1"
```

Las columnas restantes son en realidad 3 variables distintas, con 6 observaciones cada una. Se emplea la operación melt para cumplir los criterios del dataset limpio.

```{r}
paycol <- melt(data,id.vars=colnames(data)[-(7:12)],measured.vars=7:12, variable.name = "MONTHSBEFORE",value.name = "PENDINGPAYS")

paycol$MONTHSBEFORE <- sub(".*([[:digit:]])",x=paycol$MONTHSBEFORE, replacement="\\1" )

billcol <- melt(data,id.vars=colnames(data)[-(13:18)],measured.vars=13:18, variable.name = "MONTHSBEFORE",value.name = "BILL")

billcol$MONTHSBEFORE <- sub(".*([[:digit:]])",x=billcol$MONTHSBEFORE, replacement="\\1" )

amcol <- melt(data,id.vars=colnames(data)[-(19:24)],measured.vars=19:24, variable.name = "MONTHSBEFORE",value.name = "AMORTIZATION")

amcol$MONTHSBEFORE <- sub(".*([[:digit:]])",x=amcol$MONTHSBEFORE, replacement="\\1" )

tdata <- select(data,c((1:6),25))
paycol <- select(paycol,c(1,20,21))
amcol <- select(amcol,c(1,20,21))
billcol <- select(billcol,c(1,20,21))

columns <- join_all(lst(paycol,amcol,billcol),by=c("ID","MONTHSBEFORE"))
tdata <- join(tdata,columns,by="ID") %>%
  arrange(ID,MONTHSBEFORE) %>%
  select(1,8,2,3,4,5,6,9,10,11,7)

tdata$default <- factor(tdata$default)
tdata$MONTHSBEFORE <- as.numeric(tdata$MONTHSBEFORE)
```

## Analisis Exploratorio

### Historial de Retraso de Pagos
De cada usuario se obtiene el promedio de la cantidad de pagos atrasados cada mes. Hipotéticamente, aquellos usuarios que tengan más meses con más pagos vencidos, serán más propensos a no pagar el próximo mes.

```{r}
userg <- group_by(tdata,ID,default) %>% summarise(meanpp=mean(PENDINGPAYS))

ggplot(aes(y=meanpp,x=default, color=default),data=userg,main="d")+geom_boxplot()+labs(title="Promedio de faltas de pagos",subtitle = "En los últimos 6 meses")+xlab("Incumple pago")+ylab("N Pagos incumplidos")

```
Se observa a priori una ligera diferencia en el promedio para ambos grupos, teniendo una intersección en el rango intercuartílico. Por la caja de la izquierda, se observa que el 50% de los usuarios que no debieron el último pago tuvieron un promedio negativo.

Sin embargo, es posible que el comportamiento en el cumplimiento de pagos cambie, ya sea que sus pagos incumplidos se reduzcan, o se incrementen.

Para tomar en consideración esa dinámica, se calcula un promedio ponderado de la cantidad de pagos vencidos. Aquellas cantidades más recientes tendrán un mayor peso que las cantidades más antiguas. 

```{r}
tdata <- mutate(tdata,WPENDINGP=(PENDINGPAYS*(4-MONTHSBEFORE)))
userg <- group_by(tdata,ID,default) %>% summarise(meanpp=mean(PENDINGPAYS),meanwpp=mean(WPENDINGP))

ggplot(aes(y=meanwpp,x=default, color=default),data=userg,main="d")+geom_boxplot()+labs(title="Promedio poderado de faltas de pagos",subtitle = "En los últimos 6 meses")+xlab("Incumple pago")+ylab("N Pagos incumplidos")

```
En ésta otra gráfica se observa que ya no se translapan los rangos intercuartílicos, lo que podría ser de ayuda en mejorar la precisión de algún modelo al incluir este promedio ponderado.

Para verificar la certeza de que las distribuciones en los promedios antes calculados son distintas, se emplea un t test.

```{r}
ppd <- filter(userg,default==1)[,3]
ppn <- filter(userg,default==0)[,3]
t.test(ppd,ppn,paired=FALSE)
```
Dado que el p-value de este test es casi nulo, se rechaza la hipótesis nula, relativa a que ambas distribuciones tienen igual promedio.



