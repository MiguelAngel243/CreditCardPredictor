---
title: "Analisis Exploratorio"
author: "Miguel Angel G.G"
date: "28/1/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(plyr)
library(dplyr)
library(reshape2)
library(ggplot2)
library(psych)
```

## Introducción


### Revisión preeliminar de archivo


```{r pressure, echo=FALSE}

data <- read.csv("Credit_Card.csv")
str(data)
```
Los datos categoricos (sexo, educación y estado marital) están codificados como enteros. Se procede a dejar las categorías explícitas:
```{r}
data$SEX <- factor(ifelse(data$SEX==1,"Hombre","Mujer"))

data$EDUCATION <- factor(mapvalues(data$EDUCATION,0:6,c("Desc","MaestriaD","Licenciatura","Prepa","Otra","Desc","Desc")))

data$MARRIAGE <- factor(mapvalues(data$MARRIAGE, 0:3, c("Otro","Casada","Soltera","Otro")))

colnames(data)[25] <- "default"
colnames(data)[7] <- "PAY_1"
```

Las columnas restantes son en realidad 3 variables distintas, con 6 observaciones cada una. Se emplea la operación melt para cumplir los criterios del dataset limpio.

```{r}
paycol <- melt(data,id.vars=colnames(data)[-(7:12)],measured.vars=7:12, variable.name = "MONTHSBEFORE",value.name = "PENDINGPAYS")

paycol$MONTHSBEFORE <- sub(".*([[:digit:]])",x=paycol$MONTHSBEFORE, replacement="\\1" )

billcol <- melt(data,id.vars=colnames(data)[-(13:18)],measured.vars=13:18, variable.name = "MONTHSBEFORE",value.name = "BILL")

billcol$MONTHSBEFORE <- sub(".*([[:digit:]])",x=billcol$MONTHSBEFORE, replacement="\\1" )

amcol <- melt(data,id.vars=colnames(data)[-(19:24)],measured.vars=19:24, variable.name = "MONTHSBEFORE",value.name = "AMORTIZATION")

amcol$MONTHSBEFORE <- sub(".*([[:digit:]])",x=amcol$MONTHSBEFORE, replacement="\\1" )

tdata <- select(data,c((1:6),25))
paycol <- select(paycol,c(1,20,21))
amcol <- select(amcol,c(1,20,21))
billcol <- select(billcol,c(1,20,21))

columns <- join_all(lst(paycol,amcol,billcol),by=c("ID","MONTHSBEFORE"))
tdata <- join(tdata,columns,by="ID") %>%
  arrange(ID,MONTHSBEFORE) %>%
  select(1,8,2,3,4,5,6,9,10,11,7)

tdata$default <- factor(as.numeric(tdata$default))
tdata$MONTHSBEFORE <- as.numeric(tdata$MONTHSBEFORE)
```

## Analisis Exploratorio

### Prevalencia de default

```{r}
prevalence <- mean(data$default==1)
```

La prevalencia del incumplimiento de pago en el mes actual es del `r prevalence*100`%

### Correlación entre variables continuas-outcome

Se obtiene una matriz de correlación para todas las variables numericas continuas:
```{r}
cor.plot(select(data,c(-1,-(3:5))))
```

### Correlación entre variables discretas - outcome

```{r}
data$default <- factor(data$default)

ggplot(aes(x=SEX,fill=default),data=data)+geom_bar(position=position_fill())+labs(title="Probabilidad de default",subtitle="Por género")+xlab("Género")+ylab("Probabilidad")+geom_hline(yintercept = prevalence)
```

Se observa una muy sutil diferencia en los porcentajes, para corroborar esta correlación, aunque sutil, se realiza un test chi-square.

```{r}
chisq.test(data$SEX,data$default)
```
Se verifica entonces la correlación entre género e incidencia de default.

### Grado de Educación

```{r}
ggplot(aes(x=EDUCATION,fill=default),data=data)+geom_bar(position=position_fill())+labs(title="Probabilidad de Default",subtitle="Por grado de educación")+xlab("Grado")+ylab("Probabilidad")+geom_hline(yintercept = prevalence)
```
En cuanto al grado educativo, se observan ligeras diferencias entre las categorias, resaltando las categorías "Desconocido" y "Otra", donde la probilidad de default es marcadamente menor. 

Sin embargo, se podría pensar que esta diferencia se debe a la escaza cantidad de registros en dichas categorías y que, por lo tanto, en realidad esa diferencia es debida a solo unas cuantas personas que ejercen mucha influencia en el porcentaje. Si construimos la tabla de contingencia para esta relación y realizamos un test chi-square...

```{r}
chisq.test(with(data,table(EDUCATION, default)))
```
El p-value para este test es muy bajo y por lo tanto verifica la relación.

### Estado Marital

```{r}
ggplot(aes(x=MARRIAGE,fill=default),data=data)+geom_bar(position=position_fill())+labs(title="Probabilidad de Default",subtitle="Por estado marital")+xlab("Estado")+ylab("Probabilidad")+geom_hline(yintercept = prevalence)
```


### Historial de Retraso de Pagos
Como se puede ver en la matriz de correlación, los valores que tienen mayor correlación con respecto a la variable de interés (default) son los registros de la variable PAY_n, que representa el número de pagos vencidos acumulados cada mes. 

Sin embargo, y es de esperarse, los 6 observaciones de la variable PAY_n estan estrechamente relacionadas. Por lo que, incluir todas esas observaciones en un futuro modelo, puede incrementar la varianza de los coeficientes en una regresión. 

Se grafica la distribución de los valores de PAY_1 (el registro más actual y por ende, el más correlacionado con "default") mediante un boxplot:

```{r}
ggplot(aes(y=PAY_1,x=default,fill=default),data=data)+geom_boxplot()+labs(title="Distribucipon de PAY_1",subtitle = "respecto a la falta de pago")+xlab("Default")+ylab("Numero de pagos atrasados el mes anterior")
```
Se nota un desplazamiento entre ambas cajas, teniendo solo los rangos intercantílicos 0-25% y 75%-100% superpuestos.

Cabe resaltar que dos marcadores de cuantil en la caja izquierda están muy cerca, esto puede indicar una distribución muy desigual. Para verificar esto, se grafican violines para ambos grupos:

```{r}
ggplot(aes(y=PAY_1,x=default,fill=default),data=data)+geom_violin()+labs(title="Distribucipon de PAY_1 (violines)",subtitle = "respecto a la falta de pago")+xlab("Default")+ylab("Numero de pagos atrasados el mes anterior")
```
Aquí se aprecia la diferencia en las distribuciones del promedio. El violín derecho (default) es más homogéneo, conservando una considerable parte de su área por encima del eje X. 

El violín izquierdo, por su parte, concentra gran cantidad del área sobre el eje X, y el resto del área se encuentra en mayor parte debajo de dicho eje.

```{r}
dm <- mean(filter(data,default==1)[,7])-mean(filter(data,default==0)[,7])
```

Se calcula la diferencia de los promedios de ambas distribuciones: `r dm` pagos vencidos el mes anterior.

Y se realiza un t-test para tener certeza en la existencia de esta diferencia en las distribuciones:
```{r}
t.test(data$PAY_1,as.numeric(data$default),paired=FALSE)
```


### Límite de Crédito

```{r}
ggplot(aes(y=log(LIMIT_BAL),x=default, fill=default),data=tdata)+geom_violin()+labs(title="Límite de Crédito")+xlab("Incumple pago")+ylab("Límite de Crédito [$x10,000]")
```
En esta gráfica de violín no se distinguen diferencias sustanciales entre los dos grupos. Conforme los valores de límite de crédito incrementan, la diferencia en el grosor de los violines se incrementa, aunque de forma muy sutil.

### Edad

```{r}
ggplot(aes(x=AGE,fill=default),data=data)+geom_bar(position=position_fill())+labs(title="Edad")+xlab("Años")+ylab("Probabilidad de Impago")+geom_hline(yintercept = prevalence)
```

### Historial de Amortizaciones

A pesar que la matriz de correlación indique que los valores individuales del historial de amortizaciones no estan relacionados con la incidencia de default, se puede pensar que el número de registros con pagos de $0 puede indicar una tendencia a faltar el siguiente pago.

```{r}
userg <- tdata %>% group_by(ID,default) %>% summarize(NNULLPAYMENTS = sum(AMORTIZATION==0))

ggplot(aes(x=NNULLPAYMENTS,fill=default),data=userg)+geom_bar(position=position_fill())+xlab("Numero de pagos nulos")+ylab("Probabilidad")+geom_hline(yintercept = prevalence)
```
Se observa un incremento en la probabilidad de default mientras que el numero de pagos nulos es más alto. La linea horizontal está ubicada en el porcentaje de prevalencia de default. 
