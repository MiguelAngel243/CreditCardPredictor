---
title: "Analisis Exploratorio"
author: "Miguel Angel G.G"
date: "28/1/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(plyr)
library(dplyr)
library(reshape2)
library(ggplot2)
```

## Introducción


### Revisión preeliminar de archivo


```{r pressure, echo=FALSE}

data <- read.csv("Credit_Card.csv")
str(data)
```
Los datos categoricos (sexo, educación y estado marital) están codificados como enteros. Se procede a dejar las categorías explícitas:
```{r}
data$SEX <- factor(ifelse(data$SEX==1,"Hombre","Mujer"))

data$EDUCATION <- factor(mapvalues(data$EDUCATION,0:6,c("Desc","MaestriaD","Licenciatura","Prepa","Otra","Desc","Desc")))

data$MARRIAGE <- factor(mapvalues(data$MARRIAGE, 0:3, c("Otro","Casada","Soltera","Otro")))

colnames(data)[25] <- "default"
colnames(data)[7] <- "PAY_1"
```

Las columnas restantes son en realidad 3 variables distintas, con 6 observaciones cada una. Se emplea la operación melt para cumplir los criterios del dataset limpio.

```{r}
paycol <- melt(data,id.vars=colnames(data)[-(7:12)],measured.vars=7:12, variable.name = "MONTHSBEFORE",value.name = "PENDINGPAYS")

paycol$MONTHSBEFORE <- sub(".*([[:digit:]])",x=paycol$MONTHSBEFORE, replacement="\\1" )

billcol <- melt(data,id.vars=colnames(data)[-(13:18)],measured.vars=13:18, variable.name = "MONTHSBEFORE",value.name = "BILL")

billcol$MONTHSBEFORE <- sub(".*([[:digit:]])",x=billcol$MONTHSBEFORE, replacement="\\1" )

amcol <- melt(data,id.vars=colnames(data)[-(19:24)],measured.vars=19:24, variable.name = "MONTHSBEFORE",value.name = "AMORTIZATION")

amcol$MONTHSBEFORE <- sub(".*([[:digit:]])",x=amcol$MONTHSBEFORE, replacement="\\1" )

tdata <- select(data,c((1:6),25))
paycol <- select(paycol,c(1,20,21))
amcol <- select(amcol,c(1,20,21))
billcol <- select(billcol,c(1,20,21))

columns <- join_all(lst(paycol,amcol,billcol),by=c("ID","MONTHSBEFORE"))
tdata <- join(tdata,columns,by="ID") %>%
  arrange(ID,MONTHSBEFORE) %>%
  select(1,8,2,3,4,5,6,9,10,11,7)

tdata$default <- factor(as.numeric(tdata$default))
tdata$MONTHSBEFORE <- as.numeric(tdata$MONTHSBEFORE)
```

## Analisis Exploratorio

### Historial de Retraso de Pagos
De cada usuario se obtiene el promedio de la cantidad de pagos atrasados cada mes. Hipotéticamente, aquellos usuarios que tengan más meses con más pagos vencidos, serán más propensos a no pagar el próximo mes.

```{r}
userg <- group_by(tdata,ID,default) %>% summarise(meanpp=mean(PENDINGPAYS))

ggplot(aes(y=meanpp,x=default, fill=default),data=userg)+geom_boxplot()+labs(title="Promedio de faltas de pagos",subtitle = "En los últimos 6 meses")+xlab("Incumple pago")+ylab("N Pagos incumplidos")

```
Se observa a priori una ligera diferencia en el promedio para ambos grupos, teniendo una intersección en el rango intercuartílico. Por la caja de la izquierda, se observa que el 50% de los usuarios que no debieron el último pago tuvieron un promedio negativo.

Sin embargo, es posible que el comportamiento en el cumplimiento de pagos cambie, ya sea que sus pagos incumplidos se reduzcan, o se incrementen.

Para tomar en consideración esa dinámica, se calcula un promedio ponderado de la cantidad de pagos vencidos. Aquellas cantidades más recientes tendrán un mayor peso que las cantidades más antiguas. 

```{r}
tdata <- mutate(tdata,WPENDINGP=(PENDINGPAYS*(7-MONTHSBEFORE)))
userg <- group_by(tdata,ID,default) %>% summarise(meanpp=mean(PENDINGPAYS),meanwpp=mean(WPENDINGP))

ggplot(aes(y=meanwpp,x=default, fill=default),data=userg)+geom_boxplot()+labs(title="Promedio poderado de faltas de pagos",subtitle = "En los últimos 6 meses")+xlab("Incumple pago")+ylab("N Pagos incumplidos")

```
En esta otra gráfica se observa que ya no se translapan los rangos intercuartílicos, lo que podría ser de ayuda en mejorar la precisión de algún modelo al incluir este promedio ponderado.

Cabe resaltar que dos marcadores de cuantil en la caja izquierda están muy cerca, esto puede indicar una distribución muy desigual. Para verificar esto, se grafican violines para ambos grupos:

```{r}
ggplot(aes(y=meanwpp,x=default, fill=default),data=userg)+geom_violin()+labs(title="Promedio poderado de faltas de pagos",subtitle = "Gráfica de violines")+xlab("Incumple pago")+ylab("N Pagos incumplidos")
```
Aquí se aprecia la gran diferencia en las distribuciones del promedio. El violín derecho (default) es más homogéneo, conservando una considerable parte de su área por encima del eje X. 

El violín izquierdo, por su parte, concentra gran cantidad del área sobre el eje X, y el resto del área se encuentra en mayor parte debajo de dicho eje.

Se calcula la diferencia de los promedios de ambas distribuciones:
```{r}
c(mean(filter(tdata,default==1)[,12])-mean(filter(tdata,default==0)[,12]),
  mean(filter(tdata,default==1)[,8])-mean(filter(tdata,default==0)[,8]))
```

La diferencia en el promedio es más amplia para el promedio ponderado. Se conserva dicha variable en el dataset.

### Límite de Crédito

```{r}
ggplot(aes(y=log(LIMIT_BAL),x=default, fill=default),data=tdata)+geom_violin()+labs(title="Límite de Crédito")+xlab("Incumple pago")+ylab("Límite de Crédito [$]")
```
En esta gráfica de violín no se distinguen diferencias sustanciales entre los dos grupos. 


