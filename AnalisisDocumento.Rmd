---
title: "Analisis Exploratorio"
author: "Miguel Angel G.G"
date: "3/Feb/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(plyr)
library(dplyr)
library(reshape2)
library(ggplot2)
library(psych)
library(caret)
```


### Revisión preeliminar de archivo


```{r pressure, echo=FALSE}

data <- read.csv("Credit_Card.csv")
str(data)
```
En este conjunto de datos, se tienen 30,000 registros, con 25 variables cada una. Algunos pertenecientes a datos demográficos, y otros a datos de su respectiva cuenta bancaria.

Los datos financieros BILL_AMTX y PAY_AMTX tienen magnitudes diferentes para cada usuario, por lo tanto dichas variables tendrán que ser escaladas en caso de usar regresión regularizada. 

Los datos categoricos (sexo, educación y estado marital) están codificados como enteros. Se procede a dejar las categorías explícitas:
```{r}
data$SEX <- factor(ifelse(data$SEX==1,"Hombre","Mujer"))

data$EDUCATION <- factor(mapvalues(data$EDUCATION,0:6,c("Desc","MaestriaD","Licenciatura","Prepa","Otra","Desc","Desc")))

data$MARRIAGE <- factor(mapvalues(data$MARRIAGE, 0:3, c("Otro","Casada","Soltera","Otro")))

colnames(data)[25] <- "default"
colnames(data)[7] <- "PAY_1"
```

Las columnas restantes son en realidad 3 variables distintas, con 6 observaciones cada una. Se emplea la operación melt para cumplir los criterios del "dataset ordenado".

```{r}
paycol <- melt(data,id.vars=colnames(data)[-(7:12)],measured.vars=7:12, variable.name = "MONTHSBEFORE",value.name = "PENDINGPAYS")

paycol$MONTHSBEFORE <- sub(".*([[:digit:]])",x=paycol$MONTHSBEFORE, replacement="\\1" )

billcol <- melt(data,id.vars=colnames(data)[-(13:18)],measured.vars=13:18, variable.name = "MONTHSBEFORE",value.name = "BILL")

billcol$MONTHSBEFORE <- sub(".*([[:digit:]])",x=billcol$MONTHSBEFORE, replacement="\\1" )

amcol <- melt(data,id.vars=colnames(data)[-(19:24)],measured.vars=19:24, variable.name = "MONTHSBEFORE",value.name = "AMORTIZATION")

amcol$MONTHSBEFORE <- sub(".*([[:digit:]])",x=amcol$MONTHSBEFORE, replacement="\\1" )

tdata <- select(data,c((1:6),25))
paycol <- select(paycol,c(1,20,21))
amcol <- select(amcol,c(1,20,21))
billcol <- select(billcol,c(1,20,21))

columns <- join_all(lst(paycol,amcol,billcol),by=c("ID","MONTHSBEFORE"))
tdata <- join(tdata,columns,by="ID") %>%
  arrange(ID,MONTHSBEFORE) %>%
  select(1,8,2,3,4,5,6,9,10,11,7)

tdata$default <- factor(as.numeric(tdata$default))
tdata$MONTHSBEFORE <- as.numeric(tdata$MONTHSBEFORE)


```


## Prevalencia de impago (actual)

```{r}
prevalence <- mean(data$default==1)
```

La prevalencia del incumplimiento de pago en el mes actual es del `r prevalence*100`%

## Correlación entre variables continuas y variable de interés.

Se obtiene una matriz de correlación para todas las variables numericas continuas:
```{r}
cor.plot(select(data,c(-1,-(3:5))))
```

Se observa que las variables con mayor correlación con la variable de interés son los registros de los pagos atrasados mes con mes (PAY_X), y el límite de crédito (LIMIT_BAL), en ese orden. Sin embargo, los registros del estado de cuenta y cantidad pagada mensualmente parecen no tener relación directa.

Mientras que los registros de las variables PAY_X y BILL_AMTX están fuertemente relacionados de manera interna a cada variable.

## Analisis de Variables Discretas

### Género

```{r}
data$default <- factor(data$default)
levels(data$default) <- c("No","Si")

ggplot(aes(x=SEX,fill=default),data=data)+geom_bar(position=position_fill())+labs(title="Probabilidad de impago",subtitle="Por género")+xlab("Género")+ylab("Probabilidad")+geom_hline(yintercept = prevalence)
```

Se observa una muy sutil diferencia en los porcentajes de probabilidad de impago. La linea horizontal marca la prevalencia. Para corroborar esta correlación, aunque sutil, se realiza un test chi-square.

```{r}
chisq.test(data$SEX,data$default)
```
Se verifica entonces la correlación entre género e incidencia de impago.

### Grado de Educación

```{r}
ggplot(aes(x=EDUCATION,fill=default),data=data)+geom_bar(position=position_fill())+labs(title="Probabilidad de Impago",subtitle="Por grado de educación")+xlab("Grado")+ylab("Probabilidad")+geom_hline(yintercept = prevalence)
```

En cuanto al grado educativo, se observan ligeras diferencias entre las categorias, resaltando las categorías "Desconocido" y "Otra", donde la probabilidad de impago es marcadamente menor. 

Sin embargo, se podría pensar que esta diferencia se debe a la escaza cantidad de registros en dichas categorías y que, por lo tanto, en realidad esa diferencia es debida a solo unas cuantas personas que ejercen mucha influencia en el porcentaje. Si construimos la tabla de contingencia para esta relación y realizamos un test chi-square...

```{r}
chisq.test(with(data,table(EDUCATION, default)))
```
El p-value para este test es muy bajo y por lo tanto verifica la relación.

### Estado Marital

```{r}
ggplot(aes(x=MARRIAGE,fill=default),data=data)+geom_bar(position=position_fill())+labs(title="Probabilidad de Impago",subtitle="Por estado marital")+xlab("Estado")+ylab("Probabilidad")+geom_hline(yintercept = prevalence)
```

La diferencia entre los grupos "Casado-Otro" es prácticamente nula, sin embargo, el grupo de Solteros tiene un menor indice de impago.

### Edad

```{r}
ggplot(aes(x=AGE,fill=default),data=data)+geom_bar(position=position_fill())+labs(title="Probabilidad de Impago",subtitle="Por edad")+xlab("Años")+ylab("Probabilidad de Impago")+geom_hline(yintercept = prevalence)
```

En el intevalo de 20 a 50 años se notan valores ligeramente menores que en el intervalo de 50 en adelante. Este ligera diferencia se puede deber a la relación de la edad con otras variables demográficas:

```{r}
ggplot(aes(x=AGE,fill=EDUCATION),data=data)+geom_bar(position = position_stack())+labs(title="Grado Educativo por edad")+xlab("Edad")+ylab("Cantidad")
```

En el intervalo de personas de alrededor de 30 años predomina la maestría, del cual se observó, es un grupo con menor indice de falta de pago.


```{r}
ggplot(aes(x=AGE,fill=MARRIAGE),data=data)+geom_bar(position =  position_stack())+labs(title="Estado Marital por Edad")+xlab("Edad")+ylab("Cantidad")
```

Además, en dicho grupo la mayoría son solteros, grupo que también se identificó con un menor índice de falta de pago.

## Analisis de Variables Continuas

### Historial de Retraso de Pagos
Como se puede ver en la matriz de correlación, los valores que tienen mayor correlación con respecto a la variable de interés (default) son los registros de la variable PAY_n, que representa el número de pagos vencidos acumulados cada mes. 

Sin embargo, y es de esperarse, los 6 observaciones de la variable PAY_n estan estrechamente relacionadas. Por lo que, incluir todas esas observaciones en un futuro modelo, puede incrementar la varianza de los coeficientes en una regresión. 

```{r}

tdata$MONTHSBEFORE <- as.factor(tdata$MONTHSBEFORE)

fcount <- tdata %>% filter(PENDINGPAYS>0) %>% group_by(MONTHSBEFORE) %>% summarise(cnt=length(ID))
fcount$default <- factor(rep(1,6))

ggplot(data=tdata,aes(x=MONTHSBEFORE, y=PENDINGPAYS, fill=default))+geom_boxplot(outlier.shape = NA, alpha=0.6)+labs(title="Pagos pendientes cada mes", subtitle="vs Impago")+ylab("Pagos Pendientes")+xlab("Meses antes")+geom_text(data=fcount,aes(x=MONTHSBEFORE,label=cnt,y=3))+scale_y_continuous(breaks=seq(-2,5,1))+coord_cartesian(ylim=c(-2,5))
```

Solo el primer registro inmediatamente anterior tiene los promedios para ambos grupos en un valor distinto. Los demás registros, especialmente el 5 y 6, no parecen aportar mucho criterio, al momento de discriminar a los grupos. Gradualmente, el grupo de impago fue desplazando su rango intercuartílico, siendo cada vez más irregulares. Cabe resaltar que, no parece haber una cantidad significativa de casos irregulares en los meses -5 y -6. Lo que puede sugerir que este dataset fue constituido por clientes con poca antiguedad, o recién regularizados. 

Se grafica la distribución de los valores de PAY_1 (el registro más actual y por ende, el más significativo para la probabilidad impago").


```{r}
ggplot(aes(x=PAY_1,fill=default),data=data)+geom_bar(alpha=0.4, position= position_stack())+labs(title="Probabilidad de impago",subtitle = "En función del número de pagos vencidos el mes anterior")+xlab("Pagos atrasados")+ylab("Probabilidad de Impago")+coord_cartesian(xlim=c(-4,10))+geom_hline(yintercept = prevalence)+geom_vline(xintercept = 0)+coord_cartesian(xlim=c(-5,5))+scale_x_continuous(breaks=seq(-5,5,1))
```

Se aprecia un notable incremento en la probabilidad de impago cuando el número de pagos vencidos acumulados el mes anterior es mayor a 1. La probabilidad pasa a ser mayor que 50% cuando se tienen dos pagos atrasados. Por lo que cualquier usuario que tenga dos pagos atrasados es más probable que empeore, y consecuentemente aumente aún más la probabilidad de empeorar en los meses siguientes.

Se realiza un t-test para tener certeza en la existencia de esta diferencia en las distribuciones:
```{r}
t.test(data$PAY_1,as.numeric(data$default),paired=FALSE)
```


### Límite de Crédito

```{r warning=FALSE}
ggplot(aes(x=LIMIT_BAL, fill=default),data=tdata)+geom_density(alpha=0.3)+labs(title="Límite de Crédito")+ylab("Proporción")+xlab("Límite de Crédito [$]")
```

Se puede observar que, conforme el límite de crédito aumenta, disminuye la proporción de usuarios que incumplen el pago. 

### Historial del Estado de Cuenta

```{r}
tdata$MONTHSBEFORE <- factor(tdata$MONTHSBEFORE)

ggplot(aes(x=MONTHSBEFORE, y=BILL, fill=default),data=tdata)+geom_boxplot(outlier.shape = NA, alpha=0.6)+coord_cartesian(ylim=c(-20000,98000))+labs(title="Evolución y distribución",subtitle = "Del historial del Estado de Cuenta")+xlab("Meses antes")+ylab("Estado de Cuenta")
```

No hay un desplazamiento sustancial del promedio del estado de cuenta entre ambos grupos, sin embargo, se observa que el 3er cuartil del grupo de los incumplidores está por debajo del mismo cuantil para los cumplidores, lo que significa que los pagos más altos de los cumplidores por lo general son más altos que los pagos más altos de las incumplidores. Esto bien puede estar relacionado con que los usuarios incumplidores tienen límites de crédito más bajos.

Conforme pasa el tiempo, los estados de cuenta altos (valor que marca el 3er cuartil, a escala normalizada) de ambos grupos se van incrementando, aunque con mayor grado en el grupo de los cumplidores.

### Historial de Amortizaciones

```{r}
ggplot(aes(x=MONTHSBEFORE, y=AMORTIZATION, fill=default),data=tdata)+geom_boxplot(outlier.shape = NA, alpha=0.6)+coord_cartesian(ylim=c(-1000,7500))+labs(title="Evolución y distribución",subtitle = "Del historial de Amortizaciones")+xlab("Meses antes")+ylab("Cantidad Amortizada")
```

Para esta variable es más notoria una diferencia: El promedio de la cantidad pagada cada mes por los incumplidores es más baja que la cantidad promedio pagada por los cumplidores. La evolución de los pagos parece tener una tendencia creciente tanto para el promedio como para el tercer cuartil de ambos grupos, aunque al igual que en variable BILL_AMT, esta tendencia es más marcada en el grupo de los cumplidores.

## Creación de Variables Derivadas

### Historial de Amortizaciones

A pesar que la matriz de correlación indique que los valores individuales del historial de amortizaciones no estan relacionados directamente con la incidencia de impago, se puede deducir que el número de registros con pagos de $0 puede indicar una tendencia a faltar el siguiente pago.

```{r}
userg <- tdata %>% group_by(ID,default) %>% summarize(NNULLPAYMENTS = sum(AMORTIZATION==0))


ggplot(aes(x=NNULLPAYMENTS,fill=default),data=userg)+geom_bar(position=position_fill())+xlab("Numero de pagos nulos")+ylab("Probabilidad")+geom_hline(yintercept = prevalence)
```

Se observa un incremento en la probabilidad de impago conforme el número de pagos nulos es más alto. 


### Número de meses con pagos atrasados

Hasta ahora se revisó la correlación entre la incidencia de impago y el registro más actual de la variable PAY_X. Sin embargo, se puede sacar provecho de los registros anteriores, si se cuenta el número de meses con pagos atrasados, esto sugerirá que el usuario es un cierta medida irregular, y que por ende puede haber mayor probabilidad de que incumpla.

```{r}
seg <- tdata %>% group_by(ID,default) %>% summarise(IRREGMONTHS=sum(PENDINGPAYS>0))


ggplot(aes(x=IRREGMONTHS, fill=default),data=seg)+geom_bar(position=position_fill())+labs(title="Meses irregulares",subtitle = "vs Probabilidad de Impago")+ylab("Proporción")+xlab("Meses Irregulares")
```


Se observa una proporcionalidad lineal entre el número de meses con irregularidades y la probabilidad de impago.

### Porcentaje de Incremento del Estado de Cuenta

Al analizar la evolución de la variable BILL_X, lo más destacable era el desplazamiento gradual del tercer cuartil. Se construye una variable que indique cuánto incrementó el estado de cuenta desde el registro más antiguo.

```{r}
data <- mutate(data,INCRBILL=(BILL_AMT1-BILL_AMT6))
ggplot(aes(y=INCRBILL,x=default,fill=default),data=data)+geom_boxplot()+coord_cartesian(ylim=c(-4000,30000))+labs(title="Crecimiento del estado de Cuenta",subtitle = "vs Impago")+ylab("Cantidad [$]")+xlab("Impago")
```

Se confirma que el estado de cuenta de los cumplidores tiende a aumentar más que el estado de cuenta de los incumplidores.

###Incremento de la cantidad pagada

```{r}
data <- mutate(data,INCRPAYS=PAY_AMT1-PAY_AMT6)
ggplot(aes(y=INCRPAYS,x=default,fill=default),data=data)+geom_boxplot()+coord_cartesian(ylim=c(-700,3000))+labs(title="Crecimiento de los pagos",subtitle = "vs Impago")+ylab("Cantidad [$]")+xlab("Impago")
```

Se confirma que en el caso de los cumplidores aumenta en mayor medida el tamaño de sus pagos con el paso del tiempo.

## Reducción de Variables con PCA
```{r}
data <- join_all(list(data,select(userg,ID,NNULLPAYMENTS),select(seg,ID,IRREGMONTHS)),by="ID")

data$INCRBILL <- scale(data$INCRBILL)
data$INCRPAYS <- scale(data$INCRPAYS)

billpcacalc <- preProcess(data[,13:18],method="pca",pcaComp = 2)
amtpcacalc <- preProcess(data[,19:24],method="pca",pcaComp = 2)

rdata <- predict(billpcacalc,data)
rdata <- predict(amtpcacalc,rdata)

```

## Modelado

### Regresión Logística 

Se crearán tres modelos  de regresión logística:
1. Con variables originales
2. Con variables derivadas sin todos los 6 registros históricos
3. Con variables reducidas por PCA

```{r warning=FALSE, cache=TRUE}
odata <- select(data,2:25)
fdata <- select(data,2,3,4,5,6,7,13,19,26,27,28,29,25)
rfdata <- select(rdata,2,3,4,5,6,7,16,17,18,19,20,21,13)

cntl <- trainControl(method="cv", summaryFunction = twoClassSummary, classProbs = TRUE)

model1 <- train(default~.,data=odata,method="glm",metric="ROC", trControl= cntl)
model2 <- train(default~.,data=fdata,method="glm",metric="ROC", trControl= cntl)
model3 <- train(default~.,data=rfdata,method="glm",metric="ROC", trControl= cntl)

predMat <- matrix(c(
  model1$finalModel$fitted.values,
  model2$finalModel$fitted.values,
  model3$finalModel$fitted.values
  ),30000,3)

suppressPackageStartupMessages(library(verification))
roc.plot(as.numeric(data$default)-1,predMat,legend=TRUE,plot.thres =NULL, ylab="% Detección (Sensibilidad)",xlab="% Falsa Alarma (1-Specificidad)",leg.text = c("Var. Originales","Var. Derivadas","Var. Reducidas"),main="ROC de Modelos de Regresión Logística")

```

### Modelos Alternativos

Además, se construirán adicionalmente:

4. Bosque aleatorio en base a variables derivadas
4. Máquina de Soporte Vectorial Lineal en base a variables derivadas.
5. Modelo de Análisis de Discrimintante Lineal en base a variables originales.

Para la SVM se hará un barrido del parámetro Costo.

```{r}
model4 <- train(default~.,data=fdata,method="rf",metric="ROC",trControl=cntl)

gr <- expand.grid(C=c(0,0.01,0.03,0.05,0.06,0.1))
model5 <- train(default~.,data=fdata,method="svmLinear",tuneGrid=gr,metric="ROC",trControl=cntl,preProcess=c("center","scale"))

model6 <- lda(default~.,data=odata)

predMat <- matrix(c(
  model4$finalModel$votes[,2],
  predict(model5,fdata,"prob")[,2],
  predict(model6,odata)$posterior[,2]
  ),30000,3)

suppressPackageStartupMessages(library(verification))
roc.plot(as.numeric(data$default)-1,predMat,legend=TRUE,plot.thres =NULL, ylab="% Detección (Sensibilidad)",xlab="% Falsa Alarma (1-Specificidad)",leg.text = c("Random Forest","SVM","LDA"), main="ROC de Modelos Alternativos")
```


### Selección de Modelo

Se obtienen las estimaciones del parámetro AUC como criterio para evaluar el rendimiento real de los modelos mediante Cross-Validation a 10 k-folds:

```{r}
library(knitr)
kable(rbind(rbind(model1$results,model2$results,model3$results)[,2:7],model4$results[1,2:7]),caption="Rendimiento real estimado de Modelos")
```

Se selecciona el modelo de random forest para proceder a la optimización.

La matriz de confusion para este modelo, con un punto de corte de 0.5:

```{r}
confusionMatrix(model4$finalModel$predicted,data$default,positive="Si")
```

### Interpretación de Coeficientes

```{r}
exp(model2$finalModel$coefficients)
```

En esta tabla se puede observar que las varibles de incremento del estado de cuenta y de pagos, aportan poca diferencia en el porcentaje predicho por el modelo. Esto quizá se deba a que ambas están correlacionadas con el límite de crédito, y por ende, gran parte de su información se le atribuye a esta variable. Por otro lado, las variables de meses irregulares y pagos nulos, junto con la variable original de pagos pendientes tienen relevancia al momento de discriminar usuarios.

El coeficiente de Edad indica que esta variable es poco importante. Esta variable había sido relacionada con las variables del grado educativo y el estado marital, las cuales tienen bastante poder discriminatorio, y recopilan mejor la diferencia entre probabilidad de impago y edad que se había observado previamente.

### Seleccion de valores de corte
```{r}
fdata$PRED <- model2$finalModel$fitted.values
quantile(dplyr::filter(fdata,default=="Si")$PRED)
```
```{r}
quantile(dplyr::filter(fdata,default=="No")$PRED)
```

Si queremos que en el intervalo de "Riesgo bajo" se encuentre el 20% de los que incumplirán:
```{r}
a <- quantile(dplyr::filter(fdata,default=="Si")$PRED,0.2)
a
```
Y que en el intervalo de "Riesgo Miedio" y "Riesgo bajo" haya el 60%:
```{r}
b <- quantile(dplyr::filter(fdata,default=="Si")$PRED,0.6)
b
```
Realizamos los cortes a a variable predicha:
```{r}
fdata$FP <- cut(fdata$PRED,c(0,a,b,1),labels = c("Bajo","Medio","Alto"))
```

La matriz de predicción quedaría:
```{r}
with(fdata,table(default,FP))
```

```{r}
ggplot(aes(x=FP,fill=default),data=fdata)+geom_bar(position = position_stack())+labs(title="Proporción de impago",subtitle = "Por categoría predicha")+xlab("Categoría")+ylab("Cantidad de Usuarios")
```

